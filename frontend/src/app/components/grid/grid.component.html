<ion-card>
  @if (title) {
    <ion-card-header>
      <ion-card-title>{{ title }}</ion-card-title>
    </ion-card-header>
  }

  <ion-card-content>
    <!-- Search and Controls -->
    <ion-row>
      <ion-col size="12" size-md="6">
        <ion-searchbar
          [value]="searchText"
          (ionInput)="onSearchChange($event)"
          placeholder="Search..."
          show-clear-button="focus">
        </ion-searchbar>
      </ion-col>
      <ion-col size="6" size-md="3">
        <ion-select
          [value]="itemsPerPage"
          (ionChange)="onPageSizeChange($event)"
          placeholder="Items per page"
          interface="popover">
          <ion-select-option [value]="5">5 per page</ion-select-option>
          <ion-select-option [value]="10">10 per page</ion-select-option>
          <ion-select-option [value]="25">25 per page</ion-select-option>
          <ion-select-option [value]="50">50 per page</ion-select-option>
        </ion-select>
      </ion-col>
      <ion-col size="6" size-md="3">
        <ion-button expand="block" (click)="onAdd()" *ngIf="showActions">
          <ion-icon name="add" slot="start"></ion-icon>
          Add New
        </ion-button>
      </ion-col>
    </ion-row>

    <!-- Table -->
    <ion-grid class="custom-table">
      <!-- Header Row -->
      <ion-row class="table-header">
        <ion-col
          *ngFor="let column of columns"
          [size]="column.size || 'auto'"
          [class.sortable]="column.sortable"
          (click)="column.sortable ? onSort(column.key) : null">
          <div class="header-content">
            <span>{{ column.label }}</span>
            <ion-icon
              *ngIf="column.sortable && getSortIcon(column.key)"
              [name]="getSortIcon(column.key)"
              class="sort-icon">
            </ion-icon>
          </div>
        </ion-col>
        <ion-col size="auto" *ngIf="showActions">Actions</ion-col>
      </ion-row>

      <!-- Data Rows -->
      @for (item of paginatedData; track item.id) {
        <ion-row class="table-row">
          @for (column of columns; track column.key) {
            <ion-col [size]="column.size || 'auto'">
              @switch (column.type) {
                @case ('image') {
                  <img [src]="item[column.key]" alt="" class="table-image">
                }
                @case ('date') {
                  {{ item[column.key] | date }}
                }
                @default {
                  {{ item[column.key] }}
                }
              }
            </ion-col>
          }
          @if (showActions) {
            <ion-col size="auto">
              <ion-button
                fill="clear"
                size="small"
                (click)="onEdit(item)">
                <ion-icon name="create" slot="icon-only"></ion-icon>
              </ion-button>
              <ion-button
                fill="clear"
                color="danger"
                size="small"
                (click)="onDelete(item)">
                <ion-icon name="trash" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-col>
          }
        </ion-row>
      }
      @empty {
        <ion-row class="no-data">
          <ion-col>
            <ion-text color="medium">
              <p>No data found</p>
            </ion-text>
          </ion-col>
        </ion-row>
      }
    </ion-grid>

    <!-- Pagination -->
    @if (totalPages > 1) {
      <ion-row class="pagination">
        <ion-col>
          <div class="pagination-info">
            Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to
            {{ Math.min(currentPage * itemsPerPage, serverSidePagination ? data.total : filteredData.length) }}
            of {{ serverSidePagination ? data.total : filteredData.length }} entries
          </div>
        </ion-col>
        <ion-col size="auto">
          <ion-button
            fill="clear"
            [disabled]="currentPage === 1"
            (click)="goToPage(currentPage - 1)">
            <ion-icon name="chevron-back" slot="icon-only"></ion-icon>
          </ion-button>

          @for (page of getPageNumbers(); track page) {
            <ion-button
              [fill]="currentPage === page ? 'solid' : 'clear'"
              [color]="currentPage === page ? 'primary' : 'medium'"
              (click)="goToPage(page)">
              {{ page }}
            </ion-button>
          }

          <ion-button
            fill="clear"
            [disabled]="currentPage === totalPages"
            (click)="goToPage(currentPage + 1)">
            <ion-icon name="chevron-forward" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-col>
      </ion-row>
    }
  </ion-card-content>
</ion-card>

<!-- Add/Edit Modal -->
<ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ modalMode === 'add' ? 'Add New Item' : 'Edit Item' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <form>
        @for (column of columns; track column.key) {
          @if (column.type === 'text' || column.type === 'email' || column.type === 'number') {
            <ion-item>
              <ion-label position="stacked">{{ column.label }}</ion-label>
              <ion-input
                [type]="column.type"
                [value]="selectedItem?.[column.key]"
                (ionInput)="onInputChange(column.key, $event.detail.value)">
              </ion-input>
            </ion-item>
          }
          @if (column.type === 'select') {
            <ion-item>
              <ion-label position="stacked">{{ column.label }}</ion-label>
              <ion-select
                [value]="selectedItem?.[column.key]"
                (ionChange)="onInputChange(column.key, $event.detail.value)">
                @for (option of column.options || []; track option) {
                  <ion-select-option [value]="option">
                    {{ option }}
                  </ion-select-option>
                }
              </ion-select>
            </ion-item>
          }
          @if (column.type === 'checkbox') {
            <ion-item>
              <ion-checkbox
                [checked]="selectedItem?.[column.key]"
                (ionChange)="onInputChange(column.key, $event.detail.checked)">
                {{ column.label }}
              </ion-checkbox>
            </ion-item>
          }
        }

        <ion-button
          expand="block"
          (click)="onSave()"
          class="ion-margin-top">
          {{ modalMode === 'add' ? 'Add' : 'Save' }}
        </ion-button>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
